#compdef _ue4 ue4

#
# Completion for ue4 (https://docs.adamrehn.com/ue4cli/overview/introduction-to-ue4cli)
# ------------------ 
#
# Author: Paolo Di Giglio (GitHub: pdigiglio)
#         https://github.com/pdigiglio/.dotfiles/blob/master/config/zsh/completions/_ue4
#
# Version: 0.1.0
#
# Starting point to write completion files:
#  * https://blog.mads-hartmann.com/2017/08/06/writing-zsh-completion-scripts.html
#

function _ue4 {
    local -a subcommands=(
        "help\\:'Show help'"
        # Configuration-related commands
        "setroot\\:'Set an engine root path override that supercedes auto-detect'" # arg
        "clearroot\\:'Remove any previously-specified engine root path override'"
        "clearcache\\:'Clear any cached data that ue4cli has stored'"
        # Engine-related commands
        "build-target\\:'Build the specified target using UBT'" # arg
        "editor\\:'Run the editor without an Unreal project'" # arg
        "root\\:'Print the path to the root directory of the Unreal Engine'"
        "version\\:'Print the version of the Unreal Engine (default: \"full\")'"
        # Descriptor-related commands
        "build\\:'Build the Editor modules for the Unreal project or plugin'"
        "clean\\:'Clean build artifacts for the Unreal project or plugin'"
        "gen\\:'Generate IDE project files for the Unreal project'"
        "package\\:'Package a build of the Unreal project or plugin in the current directory'" # arg
        "run\\:'Run the editor for the Unreal project'" # arg
        "test\\:'Run automation tests for the Unreal project'"
        # Library-related commands
        "cmakeflags\\:'Print CMake flags for building against libs'"
        "cxxflags\\:'Print compiler flags for building against libs'"
        "ldflags\\:'Print linker flags for building against libs'"
        "includedirs\\:'Print include directories for building against libs'"
        "libfiles\\:'Print library files for building against libs'"
        "defines\\:'Print preprocessor definitions for building against libs'"
        "libs\\:'List the supported third-party libs'"
        # Automation-related commands
        "uat\\:'Invoke RunUAT with the specified arguments'" # args
    )

    local line
    _arguments -C \
        "--help[Show help]" \
        "1: :(($subcommands))" \
        "*::arg:->args"

    case $line[1] in
        setroot)
            _ue4_setroot
        ;;
        build)
            _ue4_build
        ;;
        run)
            _ue4_run
        ;;
        test)
            _ue4_test
        ;;
        gen)
            _ue4_gen
        ;;
        cmakeflags)
            _ue4_cmakeflags
        ;;
        cxxflags)
            _ue4_cxxflags 
        ;;
        defines)
            _ue4_defines 
        ;;
        includedirs)
            _ue4_includedirs 
        ;;
        ldflags)
            _ue4_ldflags 
        ;;
        libfiles)
            _ue4_libfiles 
        ;;
        version)
            _ue4_version
        ;;
    esac
}

function _ue4_setroot {
    _arguments \
        "1: :_files"
}

function _ue4_version {
    _arguments \
        "1: :(major minor patch full short)"
}

function _ue4_run {
    _arguments \
        "--debug[]" \
        "*::arg:->args"
}

function _ue4_gen {
    local line

    # NOTE:
    # '-M' is an option to fucking `arguments_`. Don't swap "-CMakefile" with
    # "-Makefile" below; otherwise "-M" will be interpreted as an option to
    # `arguments_` and you'll get:
    #
    # _describe:compadd:114: unknown match specification character `a'
    #
    # It took me way too much to figure this out.
    #
    _arguments -C \
        "-CMakefile[Generate project files for CMake]" \
        "-Makefile[Generate Linux Makefile]" \
        "-QMakefile[Generate project files for QMake]" \
        "-KDevelopfile[Generate project files for KDevelop]" \
        "-CodeliteFiles[Generate project files for Codelite]" \
        "-XCodeProjectFiles[Generate project files for XCode]" \
        "-EddieProjectFiles[Generate project files for Eddie]" \
        "-VSCode[Generate project files for Visual Studio Code]" \
        "-VSMac[Generate project files for Visual Studio Mac]" \
        "-CLion[Generate project files for CLion]" \
        "-Rider[Generate project files for Rider]" \
        "*::arg:->args"

    # The above arguments may be passed several times:
    [ "$line[1]" != "" ] && _ue4_gen
}

function _ue4_build {
    local -a configurations=(
        "Debug\\:'Build engine and game in debug'"
        "DebugGame\\:'Build game in debug'"
        "Development\\:'Enable almost all engine and game optimizations'"
        "Shipping\\:'Optimal performance. Strip console cmds, stats, profiling tools'"
        "Test\\:'Same as Shipping. Keep some console cmds, stats, and profiling tools'"
    )

    local -a targets=(
        "Game\\:'Build stand-alone executable. Requires platform-specific cooked content'"
        "Editor\\:'Build project to be opened in Unreal Editor'"
        "Client\\:'Build a client in the client-server model for multiplayer games'"
        "Server\\:'Build a Server in the client-server model for multiplayer games'"
    )

    _arguments \
        "1: :(($configurations))" \
        "2: :(($targets))" \
        "*::arg:->args"
}

function _ue4_test {
    local -a filters=(
        "Engine\\:''"
        "Smoke\\:''"
        "Stress\\:''"
        "Perf\\:''"
        "Product\\:'Tests specific to your project and its plugins'"
    )

    _arguments \
        "--list[Print the list of available tests]" \
        "--all[Run all of the available tests (including engine-wide tests)]" \
        "--filter[Run tests match the specified filter]: :(($filters))" \
        "--withrhi[Run tests with rendering enabled]" \
}

function _ue4_cmakeflags {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--multiline[Print each flag on a separate line]" \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

function _ue4_cxxflags {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--multiline[Print each flag on a separate line]" \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

function _ue4_defines {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

function _ue4_includedirs {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

function _ue4_ldflags {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--multiline[Print each flag on a separate line]" \
        "--flagsonly[Print the linker flags only (omit library names)]" \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

function _ue4_libfiles {
    # TODO:
    #  1. The options should come before the libs.
    #  2. Cache the libs.
    #  3. Avoid copy-paste.

    local -a libs=($(ue4 libs 2> /dev/null))
    _arguments \
        "--nodefaults[Omit details for building against libc++ (Linux only)]" \
        "1: :(($libs))"
}

# NOTE: There's no zsh parser for treesitter yet.
# vim: set filetype=zsh foldmethod=indent:
